<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
                integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
                crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="/stylesheets/style.css">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
                integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
                crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body class="bg-zinc-950 flex overflow-hidden text-white">
        <ul class=" h-full flex flex-col w-[4%] items-center  gap-7 p-4  text-white">
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] text-zinc-300  fa-house text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-regular max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-compass text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-regular max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-comment-dots text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-video text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-globe text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-bell text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-circle-plus text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
                <li><i class="fa-solid max-md:text-[22px] max-[480px]:text-[18px] max-lg:text-[25px] fa-search text-zinc-300 text-[22px] w-6 max-[1024px]:w-auto"></i>
                </li>
        </ul>
        <div class="seperation w-px bg-zinc-800 h-full "></div>
        <div class="ib b relative overflow-y-auto w-[20%]  bg-zinc-950">
                <div class="input w-full relative px-5 py-3">
                        <i
                                class="fas fa-search absolute max-md:hidden text-zinc-400 left-6 top-1/2 -translate-y-1/2"></i>
                        <input class="p-1 outline-none w-full text-white max-lg:w-[385px] max-[1024px]:w-[260px] max-md:hidden bg-zinc-800 rounded-md pl-8"
                                placeholder="Search" type="text" />
                </div>

                <div class="flex mt-2 justify-between px-4">
                        <p>messages</p>
                        <button class="text-blue-500">requests</button>
                </div>

                <div class="users mt-5 flex flex-col gap-1">

                        <% if (allUsers.length> 0) { %>
                                <% allUsers.forEach(e=> { %>
                                        <div class="user cursor-pointer  hover:bg-zinc-900 px-4 py-2" id="<%=e._id %>">
                                                <div class="flex gap-3 items-center">
                                                        <div class="relative">
                                                                <img src="data:image/png;base64,<%= e.pfp %>"
                                                                        class="w-11 h-11 object-cover rounded-full object-top"
                                                                        alt="">
                                                                <div id="status-<%= e._id %>"
                                                                        class="absolute w-[13px] bottom-0 right-[1px] h-[13px] rounded-full <%= e.is_active ? 'bg-green-500' : 'bg-red-500' %> border-[3px] border-zinc-900">
                                                                </div>

                                                        </div>
                                                        <div>
                                                                <p class="text-[16px]">
                                                                        <%=e.username %>
                                                                </p>
                                                                <p class="text-[12px] text-zinc-500">last message <span
                                                                                class="font-extrabold">.</span>
                                                                        <span>1h</span>
                                                                </p>
                                                        </div>
                                                </div>
                                        </div>
                                        <% }) %>
                                                <% } else { %>
                                                        <h2
                                                                class="absolute top-[50%] left-1/2 z-30 text-nowrap -translate-x-1/2 -translate-y-1/2">
                                                                Add some friends first</h2>
                                                        <% }%>


                </div>
        </div>
        <div class="seperation w-px bg-zinc-800 h-full "></div>

        <div class="dm w-[76%] max-md:w-[76%] bg-zinc-950 relative">


                <div
                        class="absolute dummyText gap-1 flex flex-col justify-center items-center top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                        <svg aria-label="" class="x1lliihq x1n2onr6 x5n08af" fill="currentColor" height="96" role="img"
                                viewBox="0 0 96 96" width="96">
                                <title></title>
                                <path
                                        d="M48 0C21.532 0 0 21.533 0 48s21.532 48 48 48 48-21.532 48-48S74.468 0 48 0Zm0 94C22.636 94 2 73.364 2 48S22.636 2 48 2s46 20.636 46 46-20.636 46-46 46Zm12.227-53.284-7.257 5.507c-.49.37-1.166.375-1.661.005l-5.373-4.031a3.453 3.453 0 0 0-4.989.921l-6.756 10.718c-.653 1.027.615 2.189 1.582 1.453l7.257-5.507a1.382 1.382 0 0 1 1.661-.005l5.373 4.031a3.453 3.453 0 0 0 4.989-.92l6.756-10.719c.653-1.027-.615-2.189-1.582-1.453ZM48 25c-12.958 0-23 9.492-23 22.31 0 6.706 2.749 12.5 7.224 16.503.375.338.602.806.62 1.31l.125 4.091a1.845 1.845 0 0 0 2.582 1.629l4.563-2.013a1.844 1.844 0 0 1 1.227-.093c2.096.579 4.331.884 6.659.884 12.958 0 23-9.491 23-22.31S60.958 25 48 25Zm0 42.621c-2.114 0-4.175-.273-6.133-.813a3.834 3.834 0 0 0-2.56.192l-4.346 1.917-.118-3.867a3.833 3.833 0 0 0-1.286-2.727C29.33 58.54 27 53.209 27 47.31 27 35.73 36.028 27 48 27s21 8.73 21 20.31-9.028 20.31-21 20.31Z">
                                </path>
                        </svg>
                        <h2 class="text-xl">Your Messages</h2>
                        <p class="text-[14px] text-zinc-500">start a message by clicking any chat</p>
                </div>

                <div class="textContainer h-full w-full hidden">
                        <div class="flex headSection p-4 gap-3 h-[10%] items-center">
                                <img src="" class="w-10 h-10 object-cover rounded-full object-top" alt="">
                                <p>username</p>
                                <i class="fa-solid fa-ellipsis ml-auto"></i>
                        </div>
                        <div class="seperation w-full bg-zinc-800 h-px "></div>

                        <div class="texts p-3 h-[80%] relative w-full overflow-y-auto flex flex-col gap-2">

                                <h2 class="text-right w-full my-[2px]"><span class="bg-zinc-700 inline-block text-[12px] text-left max-w-[50%] p-8 h-auto px-3 py-2 rounded-full">Lorem ipsum dolor sit amet consectetur adipisicing elit. Amet earum quam animi consequuntur nulla numquam in ratione optio saepe pariatur.</span></h2>

                                <div class="noChats hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                        No chats to show..</div>


                        </div>


                        <div class="h-[10%] flex justify-self-center items-center w-full px-4">
                                <form id="chat-form"
                                        class="flex w-full h-[45px] rounded-full items-center px-3 border border-zinc-600">
                                        <i class="fa-regular fa-face-smile"></i>
                                        <input type="text"
                                                class=" bg-transparent h-[24px] resize-none flex items-center outline-none px-3 w-full"
                                                name="text" id="text">
                                        <button class="text-blue-600">send</button>
                                </form>
                        </div>
                </div>

        </div>
        <div class="seperation-about w-px bg-zinc-800 hidden max-md:hidden h-full"></div>
        <div class="about hidden w-[18%] max-md:hidden bg-zinc-950">
                <div class="flex flex-col w-full items-center">
                        <h2 class=" text-[18px] flex items-center p-2">Profile info</h2>
                        <div class="seperation w-full bg-zinc-800 h-px "></div>

                        <img src="" class="w-28 mt-4 h-28 object-cover aboutImg object-top rounded-full" alt="">
                </div>
                <div class="flex justify-center gap-3 mt-4">
                        <button class="bg-zinc-800 w-[95px] py-1 rounded-md">view profile</button>
                        <button class="bg-red-600 w-[95px] py-1 rounded-md text-white">report</button>
                </div>
        </div>






        <!-- <script src="/javascripts/script.js"></script> -->
        <script>
                let users = document.querySelectorAll('.user')
                let textContainer = document.querySelector('.textContainer')
                let dummyText = document.querySelector('.dummyText')
                let chat_form = document.querySelector('#chat-form')
                let text = document.querySelector('#text')
                let noChat = document.querySelector('.noChats')

                var sender_id = '<%=user._id %>'
                var reciever_id

                var socket = io('/chat', {
                        auth: {
                                token: sender_id
                        }
                });

                socket.on('showOnline', function (data) {
                        // console.log(data)
                        let elem = document.getElementById(`status-${data.user_Id}`)
                        elem.classList.remove('bg-red-500')
                        elem.classList.add('bg-green-500')
                });

                socket.on('showOffline', function (data) {
                        let elem = document.getElementById(`status-${data.user_Id}`)
                        elem.classList.remove('bg-green-500')
                        elem.classList.add('bg-red-500')
                });

                users.forEach(e => {
                        e.addEventListener('click', (elem) => {
                                elem.stopPropagation()
                                dummyText.style.display = 'none'
                                document.querySelector('.about').style.display = 'block'
                                document.querySelector('.seperation-about').style.display = 'block'
                                textContainer.style.display = 'block'
                                reciever_id = elem.currentTarget.id
                                users.forEach(li => li.classList.remove('bg-zinc-900'));
                                elem.currentTarget.classList.add('bg-zinc-900');

                                socket.emit('catchIds', { sender_id, reciever_id })
                                socket.on('userInfo', (data) => {
                                        console.log(data)
                                        document.querySelector('.headSection').innerHTML = `<img src="data:image/png;base64,${data.pfp}" class="w-10 h-10 object-cover rounded-full object-top" alt="">
                                                                                                <p>${data.username}</p>
                                                                                                <i class="fa-solid fa-ellipsis ml-auto"></i>`
                                        document.querySelector('.aboutImg').src = `data:image/png;base64,${data.pfp}`
                                })
                        })
                })

                chat_form.addEventListener('submit', (e) => {
                        e.preventDefault()

                        if (text.value != '') {
                                fetch('/save-chat', {
                                        method: 'POST',
                                        headers: {
                                                'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                                sender_id: sender_id,
                                                reciever_id: reciever_id,
                                                text: text.value,
                                        }),
                                }).then((data) => {
                                        return data.json()
                                }).then(resp => {
                                        console.log(resp)

                                        if (resp.success) {
                                                if (noChat) {
                                                        noChat.style.display = 'none'
                                                }
                                                let html = `<h2 class="text-right w-full my-[2px]"><span class="bg-zinc-700 max-w-[45%] px-3 py-2 rounded-full">${resp.chat.message}</span></h2>`
                                                document.querySelector('.texts').innerHTML += html
                                                text.value = ''

                                                socket.emit('newChat', resp.chat)
                                        }

                                })
                        }

                })

                socket.on('loadChat', (data) => {
                        console.log('loadChat: ', data)
                        if (noChat) {
                                noChat.style.display = 'none'
                        }
                        if (sender_id == data.recieverId && reciever_id == data.senderId) {
                                let html = `<h2 class="text-left w-full my-[2px]"><span class="border max-w-[45%] border-zinc-700 px-3 py-2 rounded-full">${data.message}</span></h2>`
                                document.querySelector('.texts').innerHTML += html
                        }
                })

                socket.on('loadOldChats', (data) => {
                        let chats = data
                        console.log(data)

                        if (chats.length > 0) {
                                document.querySelector('.texts').innerHTML = ''
                                let html = ''

                                chats.forEach(e => {

                                        console.log(e)

                                        let className = ''
                                        let bg = ''

                                        if (e.senderId == sender_id) {
                                                className = 'text-right'
                                                bg = 'bg-zinc-700'
                                        } else {
                                                className = 'text-left '
                                                bg = 'border border-zinc-700'
                                        }

                                        html += `<h2 class="${className} w-full my-[2px]"><span class="${bg} max-w-[45%] px-3 py-2 rounded-full">${e.message}</span></h2>`

                                })
                                document.querySelector('.texts').innerHTML = html
                        } else {

                                noChat.style.display = 'block'
                        }
                })

                socket.emit('recieverId', reciever_id)



        </script>
</body>

</html